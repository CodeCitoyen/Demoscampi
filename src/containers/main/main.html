<div class="main" ng-class="{'main--has-feedback': $ctrl.showFeedback}">
  <main-toolbar game="$ctrl.game"></main-toolbar>

  <div class="main__intro" ng-if="!$ctrl.started">
    <div class="main__intro__content">
      <h1 class="main__intro__content__heading" data-fittext="1">
        The Good, The Bad<br /> and The Accountant
      </h1>
      <div class="main__intro__content__delayed">
        <p class="main__intro__content__meta lead">
          — by <a href="http://jplusplus.org" target="_blank">Journalism++</a>
        </p>
        <div class="main__intro__content__description lead">
          <p>You're the general manager of a large city. Balance ethics and the sirens of corruption to keep your position and get things done in town while remaining on the good side of the law.</p>
          <p>Whatever happens, don't get caught!</p>
        </div>
        <button class="btn btn-lg btn-primary main__intro__content__start mt-2 ml-2" ng-click="$ctrl.start()">
          Start a new game
        </button>
        <button class="btn btn-lg btn-primary main__intro__content__start mt-2 ml-2" ng-click="$ctrl.load()" ng-if="$ctrl.history.length">
          Continue
        </button>
      </div>
    </div>
  </div>

  <div class="main__steps" id="main-panel" ui-view scroll-glue ng-class="{ 'main__steps--has-footer': $ctrl.displayFooter() }">
    <div ng-repeat="year in $ctrl.visibleYears()">
      <!-- Display year banner when it starts -->
      <div class="main__steps__year" ng-if="year <= $ctrl.game.step.year">
        <img class="main__steps__year__banner" ng-src="{{::$ctrl.game.findPicture(year)}}" />
        {{::year}}:&nbsp;{{::$ctrl.game.yearInfo(year).title}}
      </div>
      <div class="main__steps__item card card-block" ng-repeat="step in $ctrl.game.journey|filter:{year}">
        <!-- Display chats-->
        <stack stack="step" game="$ctrl.game"></stack>
        <!-- Display choices-->
        <fieldset class="main__steps__item__choices" ng-if="step.isLastSlice() && !step.selection">
          <div class="list-unstyled row mb-0">
            <div class="col-lg mt-1 main__steps__item__choices__btn" ng-class="{ 'col-lg-6': step.choices.length > 3 }" ng-repeat="choice in :: step.choices">
              <button class="btn btn-block btn-sm btn-primary" ng-click="step.select(choice)" ng-class="{ active: step.selection == choice }">
                {{::choice.text}}
              </button>
            </div>
          </div>
        </fieldset>
        <!-- Display helpers -->
        <stack stack="step.helper" game="$ctrl.game" ng-if="step.displayHelper()"></stack>
        <!-- Display feedback after choices-->
        <stack stack="step.selection" game="$ctrl.game" ng-if="step.selection && step.selection.hasFeedback()"></stack>
      </div>
    </div>
    <!-- Game is over ! -->
    <div class="main__steps__over" ng-if="$ctrl.game.isOver() && !$ctrl.showFeedback">
      <div ng-bind-html="$ctrl.game.end.text | unsafe" class="lead"></div>
      <div class="text-right">
        <button class="btn btn-link" ng-click="$ctrl.game.undo()">
          <i class="fa fa-undo fa-fw"></i>
          Undo last action
        </button>
        <button class="btn btn-secondary" ng-click="$ctrl.playAgain()">
          Play again
        </button>
      </div>
    </div>
  </div>

  <div class="main__picture" ng-repeat="picture in $ctrl.game.pictures track by $index" ng-if="picture === $ctrl.game.picture">
    <img ng-src="{{ picture }}"  class="main__picture__img" />
  </div>

  <div class="main__footer" ng-if="$ctrl.displayFooter()">
    <!-- Cancel button when the step is over-->
    <button class="main__footer__undo btn btn-link btn-sm px-3" ng-click="$ctrl.game.undo()" ng-disabled="!$ctrl.game.canUndo()">
      <i class="fa fa-undo fa-fw"></i>
      Undo <span class="hidden-xs-down">last action</span>
    </button>
    <div class="main__footer__timeline">
      <div class="container-fluid">
        <div class="row">
          <div ng-repeat="year in :: $ctrl.game.years" class="col main__footer__timeline__year"  ng-class="{ 'main__footer__timeline__year--active':  year <= $ctrl.game.step.year }">
            <div class="main__footer__timeline__year__label">
              {{::year}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
